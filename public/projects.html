<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Projects - Olumba</title>
<link rel="icon" type="image/png" href="/assets/faviconolumba.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script>tailwind.config = {theme: {extend: {colors: {primary: "#2171f2", "accent-1": "#22C55E", "accent-2": "#FF8C42", background: "#FFFFFF", "background-alt": "#F3F4F6", "text-color": "#22223B", "footer-border": "#1E293B"}, fontFamily: {display: "Inter"}}}};</script>

<!-- Clerk SDK removed - no authentication required -->

<!-- App Scripts -->
<script src="/js/config.js"></script>
<!-- Clerk authentication scripts removed -->
</head>
<body class="bg-background-alt font-display text-text-color">
<div id="app"></div>

<!-- New Project Modal -->
<div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-2xl w-full mx-4">
        <h2 class="text-2xl font-bold text-text-color mb-4">Create New Project</h2>
        <form id="newProjectForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Project Name *</label>
                    <input type="text" id="projectName" required class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Description</label>
                    <textarea id="projectDescription" rows="3" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Start Date</label>
                        <input type="date" id="projectStartDate" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Deadline</label>
                        <input type="date" id="projectDeadline" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelProjectBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Create Project</button>
            </div>
        </form>
    </div>
</div>

<script src="/js/api.js"></script>
<script src="/js/nav.js"></script>
<script>
// Test API connectivity
async function testApiConnectivity() {
    console.log('üß™ Testing API connectivity...');
    
    try {
        const response = await fetch('/api/test', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('üìä Test API response status:', response.status);
        console.log('üìã Test API response headers:', Object.fromEntries(response.headers.entries()));
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Test API response:', data);
            return true;
        } else {
            const text = await response.text();
            console.error('‚ùå Test API failed:', text);
            return false;
        }
    } catch (error) {
        console.error('üí• Test API error:', error);
        return false;
    }
}

// Initialize page - NO AUTHENTICATION REQUIRED
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('‚úÖ Projects page loading without authentication');
        
        // Test API connectivity first
        const apiWorking = await testApiConnectivity();
        if (!apiWorking) {
            console.error('‚ùå API connectivity test failed');
            showNotification('API connection failed. Please check your connection.', 'error');
        }
        
        // Initialize navigation
        initNav('projects');
        
        // Initialize page content
        initializeProjectsPage();
    } catch (error) {
        console.error('‚ùå Error initializing projects page:', error);
    }
});

function initializeProjectsPage() {
    // Get main content area
    const mainContent = document.getElementById('mainContent');

    // Render projects content
    mainContent.innerHTML = `
<div class="p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-text-color">Projects</h1>
                <p class="text-text-color/60 mt-1">Manage and track all your projects</p>
            </div>
            <button id="newProjectBtn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90">
                <span class="material-symbols-outlined">add</span>
                New Project
            </button>
        </div>

        <!-- Projects Grid -->
        <div id="projectsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-12">
                <span class="material-symbols-outlined text-6xl text-text-color/30">folder_open</span>
                <p class="text-text-color/60 mt-4">Loading projects...</p>
            </div>
        </div>
    </div>
</div>
`;

    // Setup event listeners
    setupProjectsEventListeners();
    
    // Load projects
    loadProjects();
}

function setupProjectsEventListeners() {
    const newProjectBtn = document.getElementById('newProjectBtn');
    const newProjectModal = document.getElementById('newProjectModal');
    const cancelProjectBtn = document.getElementById('cancelProjectBtn');
    const newProjectForm = document.getElementById('newProjectForm');

    // Modal controls
    newProjectBtn.addEventListener('click', () => {
        newProjectModal.classList.remove('hidden');
    });

    cancelProjectBtn.addEventListener('click', () => {
        newProjectModal.classList.add('hidden');
    });

    // Create project
    newProjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Creating...';
        
        try {
            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                start_date: document.getElementById('projectStartDate').value || null,
                deadline: document.getElementById('projectDeadline').value || null
            };
            
            console.log('üöÄ Creating project with data:', projectData);
            console.log('üì° Making API request to /api/projects...');
            
            const result = await projects.create(projectData);
            console.log('‚úÖ Project created successfully:', result);
            
            if (result) {
                newProjectModal.classList.add('hidden');
                newProjectForm.reset();
                
                // IMPORTANT: Reload the projects list
                await loadProjects();
                
                // Show success message
                showNotification('Project created successfully!', 'success');
            }
        } catch (error) {
            console.error('Create project error:', error);
            
            let errorMessage = error.message || 'Failed to create project';
            
            // Provide helpful error messages
            if (errorMessage.includes('Authentication required')) {
                errorMessage = 'Please log in to create projects. You will be redirected to the login page.';
                setTimeout(() => {
                    // Login redirect removed
                }, 2000);
            }
            
            showNotification(errorMessage, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Create Project';
        }
    });
}

// Load projects
async function loadProjects() {
    console.log('üîç Starting to load projects...');
    const projectsContainer = document.getElementById('projectsContainer');
    
    try {
        console.log('üì° Fetching from /api/projects...');
        
        const response = await fetch('/api/projects', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('üìä Response status:', response.status);
        console.log('üìã Response headers:', response.headers);
        console.log('‚úÖ Response OK?', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Response not OK:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const text = await response.text();
        console.log('üìÑ Raw response:', text);
        
        const data = JSON.parse(text);
        console.log('‚úÖ Parsed data:', data);
        console.log('üì¶ Projects array:', data.data || data.projects);
        
        // Display the projects
        const projectsData = data.data || data.projects || [];
        renderProjects(projectsData);
        
    } catch (error) {
        console.error('üí• Error loading projects:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        // Show error to user
        if (projectsContainer) {
            projectsContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <span class="material-symbols-outlined text-6xl text-red-500">error</span>
                    <p class="text-red-500 mt-4">Failed to load projects: ${error.message}</p>
                    <p class="text-text-color/60 mt-2">Check console for details</p>
                </div>
            `;
        }
    }
}

function renderProjects(projectsData) {
    console.log('üé® Displaying projects:', projectsData);
    const projectsContainer = document.getElementById('projectsContainer');
    
    if (!projectsContainer) {
        console.error('‚ùå Projects container not found!');
        return;
    }
    
    // Check if projects array is empty
    if (!projectsData || projectsData.length === 0) {
        console.log('‚ÑπÔ∏è No projects to display');
        projectsContainer.innerHTML = `
            <div class="col-span-full text-center py-12">
                <span class="material-symbols-outlined text-6xl text-text-color/30">folder_open</span>
                <p class="text-text-color/60 mt-4">No projects yet. Create your first project!</p>
            </div>
        `;
        return;
    }
    
    // Render each project
    projectsContainer.innerHTML = projectsData.map(project => {
        console.log('Rendering project:', project.name);
        
        // Format dates
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        };
        
        // Format budget
        const formatBudget = (budget) => {
            if (!budget && budget !== 0) return '$0';
            return '$' + Number(budget).toLocaleString('en-US');
        };
        
        return `
            <div class="bg-background rounded-xl shadow-sm p-6 border border-footer-border/10 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='/project-detail.html?id=${project.id}'">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="text-lg font-bold text-text-color">${escapeHtml(project.name)}</h3>
                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${getStatusColor(project.status)}">
                        ${escapeHtml(project.status || 'Unknown')}
                    </span>
                </div>
                <p class="text-sm text-text-color/60 mb-4 line-clamp-2">${escapeHtml(project.description || 'No description')}</p>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-text-color/40 text-sm">calendar_today</span>
                        <span class="text-text-color/60">${formatDate(project.startDate)} - ${formatDate(project.endDate)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-text-color/40 text-sm">attach_money</span>
                        <span class="text-text-color/60">${formatBudget(project.budget)}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    console.log('‚úÖ Projects displayed successfully');
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getStatusColor(status) {
    const colors = {
        'planning': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-primary/20 text-primary',
        'on_hold': 'bg-accent-2/20 text-accent-2',
        'completed': 'bg-accent-1/20 text-accent-1'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

// Show notification helper
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}
</script>
</body>
</html>