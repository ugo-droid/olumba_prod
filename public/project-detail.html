<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Project Details - Olumba</title>
    <link rel="icon" type="image/png" href="/assets/faviconolumba.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script>tailwind.config = {theme: {extend: {colors: {primary: "#2171f2", "accent-1": "#22C55E", "accent-2": "#FF8C42", background: "#FFFFFF", "background-alt": "#F3F4F6", "text-color": "#22223B", "footer-border": "#1E293B"}, fontFamily: {display: "Inter"}}}};</script>
</head>
<body class="bg-background-alt font-display text-text-color">
<div id="app"></div>

<!-- Edit Project Modal -->
<div id="editProjectModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-2xl w-full mx-4 my-8">
        <h2 class="text-2xl font-bold text-text-color mb-4">Edit Project</h2>
        <form id="editProjectForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Project Name *</label>
                    <input type="text" id="editProjectName" required class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Description</label>
                    <textarea id="editProjectDescription" rows="3" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Status</label>
                        <select id="editProjectStatus" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="planning">Planning</option>
                            <option value="in_progress">In Progress</option>
                            <option value="on_hold">On Hold</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Discipline</label>
                        <input type="text" id="editProjectDiscipline" placeholder="e.g., Architecture" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Start Date</label>
                        <input type="date" id="editProjectStartDate" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Deadline</label>
                        <input type="date" id="editProjectDeadline" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Budget ($)</label>
                    <input type="number" id="editProjectBudget" placeholder="e.g., 5000000" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Address</label>
                    <input type="text" id="editProjectAddress" placeholder="Project location" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelEditProjectBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-2xl w-full mx-4">
        <h2 class="text-2xl font-bold text-text-color mb-4">Create Task</h2>
        <form id="addTaskForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Task Name *</label>
                    <input type="text" id="taskName" required placeholder="e.g., Review structural drawings" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Description</label>
                    <textarea id="taskDescription" rows="3" placeholder="Task details..." class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Assign To</label>
                        <select id="taskAssignee" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-color mb-1">Priority</label>
                        <select id="taskPriority" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Due Date</label>
                    <input type="date" id="taskDueDate" class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelTaskBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Create Task</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-text-color mb-4">Add Team Member</h2>
        <form id="addMemberForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Team Member *</label>
                    <select id="memberUser" required class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="">Select user</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Role *</label>
                    <select id="memberRole" required class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="">Select role</option>
                        <option value="manager">Project Manager</option>
                        <option value="architect">Architect</option>
                        <option value="engineer">Engineer</option>
                        <option value="consultant">Consultant</option>
                        <option value="client">Client</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelMemberBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Add Member</button>
            </div>
        </form>
    </div>
</div>

<!-- Invite Consultant Modal -->
<div id="inviteConsultantModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-lg w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-text-color">Invite Consultant via Email</h2>
            <span class="material-symbols-outlined text-accent-1 text-3xl">mail</span>
        </div>
        <p class="text-sm text-text-color/70 mb-6">Send a secure invitation link to a consultant. They'll receive an email with project details and instructions to sign up or log in.</p>
        
        <form id="inviteConsultantForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Consultant Email *</label>
                    <input type="email" id="consultantEmail" required placeholder="consultant@example.com" class="w-full px-4 py-3 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"/>
                    <p class="text-xs text-text-color/60 mt-1">They'll receive an email invitation to join this project</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Personal Message (Optional)</label>
                    <textarea id="consultantMessage" rows="3" placeholder="Add a personal message to the invitation email..." class="w-full px-4 py-3 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                </div>

                <div class="bg-accent-1/10 border border-accent-1/30 rounded-lg p-4">
                    <p class="text-sm text-accent-1 flex items-start gap-2">
                        <span class="material-symbols-outlined text-lg">info</span>
                        <span>The consultant will automatically get access to project files and be added to the team when they accept the invitation.</span>
                    </p>
                </div>

                <div id="inviteSuccessMessage" class="hidden bg-accent-1/10 border border-accent-1/30 text-accent-1 px-4 py-3 rounded" role="alert">
                    <p class="font-medium mb-2">✅ Invitation Sent Successfully!</p>
                    <p class="text-sm">An email has been sent to <span id="sentToEmail"></span></p>
                    <div class="mt-3 p-3 bg-background rounded text-xs break-all">
                        <p class="font-medium mb-1">Share this link directly:</p>
                        <p id="inviteLinkDisplay" class="text-primary"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelConsultantBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-accent-1 text-white rounded-lg hover:bg-accent-1/90 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">send</span>
                    Send Invitation
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Upload Document Modal -->
<div id="uploadDocModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-background rounded-xl shadow-xl p-6 max-w-lg w-full mx-4">
        <h2 class="text-2xl font-bold text-text-color mb-4">Upload Document</h2>
        <form id="uploadDocForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-color mb-1">Select File *</label>
                    <input 
                        type="file" 
                        id="document-file" 
                        name="file"
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip"
                        required
                        class="w-full px-4 py-2 border border-footer-border/20 rounded-lg focus:ring-2 focus:ring-primary"
                    >
                    <small class="text-xs text-text-color/60">Accepted formats: PDF, Word, Excel, Images, ZIP (Max 10MB)</small>
                </div>
                <div class="bg-background-alt rounded-lg p-4">
                    <p class="text-xs text-text-color/60"><strong>Note:</strong> File upload currently stores metadata only. Actual file storage requires server integration.</p>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button type="button" id="cancelUploadBtn" class="flex-1 px-4 py-2 border border-footer-border/20 rounded-lg hover:bg-background-alt">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Upload Document</button>
            </div>
        </form>
    </div>
</div>

<script src="/config.js"></script>
<script src="/js/api.js"></script>
<script src="/js/nav.js"></script>
<script src="/js/supabaseClient.js"></script>
<script>
true // Authentication removed;

// Initialize navigation
initNav('projects');

// Get project ID from URL
function getProjectIdFromUrl() {
  console.log('=== GET PROJECT ID FROM URL DEBUG ===');
  console.log('Full URL:', window.location.href);
  console.log('Search params:', window.location.search);
  
  const urlParams = new URLSearchParams(window.location.search);
  console.log('URL params object:', urlParams);
  
  const projectId = urlParams.get('id');
  console.log('📋 Project ID from URL:', projectId);
  console.log('Project ID type:', typeof projectId);
  console.log('Project ID length:', projectId?.length);
  
  if (!projectId) {
    console.error('❌ No project ID found in URL!');
    console.log('Available URL params:');
    for (let [key, value] of urlParams.entries()) {
      console.log(`  ${key}: ${value}`);
    }
  } else {
    console.log('✅ Project ID found, will attempt to load');
  }
  
  console.log('=== END PROJECT ID DEBUG ===');
  return projectId;
}

const projectId = getProjectIdFromUrl();

if (!projectId) {
    console.error('❌ No project ID in URL');
    alert('No project specified');
    window.location.href = '/projects.html';
}

// Get main content area
const mainContent = document.getElementById('mainContent');

let currentProject = null;

// Render project detail content
mainContent.innerHTML = `
<div class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-2 text-sm text-text-color/60 mb-4">
                <a href="/projects.html" class="hover:text-primary">Projects</a>
                <span class="material-symbols-outlined text-sm">chevron_right</span>
                <span class="font-medium text-text-color" id="projectBreadcrumb">Project</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-3xl font-bold text-text-color" id="projectName">Loading...</h1>
                    <span id="projectStatus" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium">Status</span>
                </div>
                <button onclick="editProject()" class="flex items-center gap-2 px-4 py-2 border border-primary/50 bg-primary/10 text-primary rounded-lg hover:bg-primary/20">
                    <span class="material-symbols-outlined">edit</span>
                    Edit Project
                </button>
            </div>
            <p class="text-text-color/60 mt-2" id="projectDescription">Loading description...</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-background rounded-xl p-4 shadow-sm border border-footer-border/10">
                <p class="text-sm text-text-color/60">Total Tasks</p>
                <p class="text-2xl font-bold text-text-color mt-1" id="totalTasks">0</p>
            </div>
            <div class="bg-background rounded-xl p-4 shadow-sm border border-footer-border/10">
                <p class="text-sm text-text-color/60">Completed</p>
                <p class="text-2xl font-bold text-accent-1 mt-1" id="completedTasks">0</p>
            </div>
            <div class="bg-background rounded-xl p-4 shadow-sm border border-footer-border/10">
                <p class="text-sm text-text-color/60">Documents</p>
                <p class="text-2xl font-bold text-text-color mt-1" id="documentCount">0</p>
            </div>
            <div class="bg-background rounded-xl p-4 shadow-sm border border-footer-border/10">
                <p class="text-sm text-text-color/60">Team Members</p>
                <p class="text-2xl font-bold text-text-color mt-1" id="memberCount">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Tasks -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10">
                    <div class="p-6 border-b border-footer-border/10 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-text-color">Project Tasks</h2>
                        <button onclick="createTask()" class="text-sm text-primary hover:text-primary/80 font-medium">+ Add Task</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b border-primary bg-primary">
                                <tr>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Task Name</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Assigned To</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Due Date</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tasksList" class="divide-y divide-footer-border/10">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-text-color/60 text-sm">Loading tasks...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Documents -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10">
                    <div class="p-6 border-b border-footer-border/10 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-text-color">Document Management</h2>
                        <button onclick="showUploadDocModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            <span class="material-symbols-outlined">upload_file</span>
                            Upload Document
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b border-primary bg-primary">
                                <tr>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Name</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Size</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Uploaded By</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Upload Date</th>
                                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documents-table-body" class="divide-y divide-footer-border/10">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-text-color/60 text-sm">Loading documents...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- City Submittals & Approvals -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10">
                    <div class="p-6 border-b border-footer-border/10 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-text-color">City Submittals & Approvals</h2>
                        <a href="/city-approvals.html" class="text-sm text-primary hover:text-primary/80 font-medium">View All →</a>
                    </div>
                    <div id="submittalsList">
                        <div class="p-6 text-center text-text-color/60 text-sm">Loading submittals...</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Project Info -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10 p-6">
                    <h3 class="text-lg font-semibold text-text-color mb-4">Project Information</h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-text-color/60">Address</p>
                            <p class="font-medium text-text-color" id="projectAddress">-</p>
                        </div>
                        <div>
                            <p class="text-text-color/60">Discipline</p>
                            <p class="font-medium text-text-color" id="projectDiscipline">-</p>
                        </div>
                        <div>
                            <p class="text-text-color/60">Start Date</p>
                            <p class="font-medium text-text-color" id="projectStartDate">-</p>
                        </div>
                        <div>
                            <p class="text-text-color/60">Deadline</p>
                            <p class="font-medium text-text-color" id="projectDeadline">-</p>
                        </div>
                        <div>
                            <p class="text-text-color/60">Budget</p>
                            <p class="font-medium text-text-color" id="projectBudget">-</p>
                        </div>
                    </div>
                </div>

                <!-- Team Members -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-text-color">Project Team</h3>
                        <div class="flex gap-2">
                            <button onclick="inviteConsultant()" class="text-sm text-accent-1 hover:text-accent-1/80 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">mail</span>
                                Invite Consultant
                            </button>
                            <button onclick="addMember()" class="text-sm text-primary hover:text-primary/80">+ Add Member</button>
                        </div>
                    </div>
                    <div id="membersList" class="space-y-3">
                        <p class="text-sm text-text-color/60 text-center py-2">Loading team...</p>
                    </div>
                </div>

                <!-- Client/Consultant View Toggle -->
                <div class="bg-background rounded-xl shadow-sm border border-footer-border/10 p-6">
                    <h3 class="text-lg font-semibold text-text-color mb-4">External View Settings</h3>
                    <div class="p-4 rounded-lg bg-primary/10">
                        <div class="flex items-center justify-between">
                            <p class="font-medium text-sm text-primary">Show Only Latest Versions</p>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input id="latestOnlyToggle" checked class="sr-only peer" type="checkbox"/>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <p class="text-xs text-text-color/60 mt-2">When enabled, clients & consultants see only the latest version of documents.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
`;

const uploadDocModal = document.getElementById('uploadDocModal');
const uploadDocForm = document.getElementById('uploadDocForm');
const cancelUploadBtn = document.getElementById('cancelUploadBtn');

async function loadProjectDetails() {
    console.log('🔍 Starting to load project details...');
    console.log('=== PROJECT DETAILS DEBUG ===');
    console.log('Full URL:', window.location.href);
    console.log('Search params:', window.location.search);
    console.log('Project ID from URL:', projectId);
    console.log('Project ID type:', typeof projectId);
    console.log('Project ID length:', projectId?.length);
    
    if (!projectId) {
        console.error('❌ No project ID found in URL!');
        throw new Error('No project ID provided');
    }
    
    try {
        console.log('📡 Fetching project with path parameter:', projectId);
        console.log('API URL:', `/api/projects/${projectId}`);
        
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📊 Response status:', response.status);
        console.log('✅ Response OK?', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`Failed to fetch project: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('📄 Raw response:', text);
        
        const result = JSON.parse(text);
        console.log('✅ Parsed result:', result);
        
        currentProject = result.data || result.project || result;
        console.log('📦 Project data:', currentProject);
        console.log('=== DISPLAY PROJECT DETAILS START ===');
        console.log('🎨 Displaying project data:', currentProject);
        console.log('Project type:', typeof currentProject);
        console.log('Project keys:', Object.keys(currentProject || {}));
        
        // Check if all required elements exist
        const requiredElements = [
            'projectBreadcrumb', 'projectName', 'projectDescription', 'projectStatus',
            'totalTasks', 'completedTasks', 'documentCount', 'memberCount',
            'projectAddress', 'projectDiscipline', 'projectStartDate', 'projectDeadline', 'projectBudget'
        ];
        
        console.log('Checking required elements...');
        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            console.log(`Element ${id}:`, element ? 'FOUND' : 'NOT FOUND');
            if (!element) {
                console.error(`❌ Missing element: ${id}`);
            }
        });
        
        if (!currentProject) {
            console.error('❌ No project data provided');
            throw new Error('No project data available');
        }
        
        console.log('Updating project details...');
        
        // Header
        console.log('Setting project name:', currentProject.name);
        document.getElementById('projectBreadcrumb').textContent = currentProject.name;
        document.getElementById('projectName').textContent = currentProject.name;
        document.getElementById('projectDescription').textContent = currentProject.description || 'No description';
        document.getElementById('projectStatus').textContent = currentProject.status?.replace('_', ' ') || 'Unknown';
        document.getElementById('projectStatus').className = `inline-flex items-center rounded-full px-3 py-1 text-sm font-medium ${getStatusColor(currentProject.status)}`;
        
        // Stats
        console.log('Setting stats...');
        document.getElementById('totalTasks').textContent = currentProject.total_tasks || 0;
        document.getElementById('completedTasks').textContent = currentProject.completed_tasks || 0;
        document.getElementById('documentCount').textContent = currentProject.document_count || 0;
        document.getElementById('memberCount').textContent = currentProject.members?.length || 0;
        
        // Project Info
        console.log('Setting project info...');
        document.getElementById('projectAddress').textContent = currentProject.address || 'Not specified';
        document.getElementById('projectDiscipline').textContent = currentProject.discipline || 'Not specified';
        document.getElementById('projectStartDate').textContent = currentProject.start_date || 'Not set';
        document.getElementById('projectDeadline').textContent = currentProject.deadline || 'Not set';
        document.getElementById('projectBudget').textContent = currentProject.budget ? '$' + currentProject.budget.toLocaleString() : 'Not set';
        
        console.log('✅ Project details HTML updated');
        console.log('=== DISPLAY PROJECT DETAILS END ===');
        
        // Add simple test display for debugging
        displayProjectDetailsSimple(currentProject);
        
        console.log('✅ Project details loaded successfully');
        
        // Load tasks
        await loadProjectTasks();
        
        // Load documents
        await loadProjectDocuments();
        
        // Load submittals
        await loadProjectSubmittals();
        
        // Load team members
        await loadProjectTeam();
        
        // Render team members
        renderTeamMembers(currentProject.members || []);
        
    } catch (error) {
        console.error('💥 Error loading project details:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        // Show error to user
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-red-500 mb-4">error</span>
                            <h2 class="text-2xl font-bold text-red-500 mb-2">Failed to load project details</h2>
                            <p class="text-text-color/60 mb-4">${error.message}</p>
                            <p class="text-sm text-text-color/40 mb-6">Check console for details</p>
                            <button onclick="window.location.href='/projects.html'" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90">
                                Back to Projects
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } else {
            alert('Failed to load project details: ' + error.message);
            window.location.href = '/projects.html';
        }
    }
}

async function loadProjectTasks() {
    console.log('📋 Loading tasks for project:', projectId);
    
    try {
        console.log('📡 Fetching tasks from API...');
        const response = await fetch(`/api/tasks?projectId=${projectId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📊 Response status:', response.status);
        console.log('✅ Response OK?', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('✅ Tasks response:', result);
        
        const tasksData = result.data || result.tasks || [];
        console.log('📦 Tasks data:', tasksData);
        
        renderTasks(tasksData);
        
    } catch (error) {
        console.error('💥 Error loading tasks:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        const tasksList = document.getElementById('tasksList');
        if (tasksList) {
            tasksList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500 text-sm">Failed to load tasks</td></tr>';
        }
    }
}

async function loadProjectDocuments() {
    console.log('📋 Loading documents for project:', projectId);
    
    try {
        const response = await fetch(`/api/documents?projectId=${projectId}`);
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Documents result:', result);
        
        const documents = result.data || result.documents || [];
        console.log('✅ Documents loaded:', documents.length);
        
        displayDocuments(documents);
        
    } catch (error) {
        console.error('💥 Error loading documents:', error);
        
        const container = document.getElementById('documents-table-body');
        
        if (container) {
            container.innerHTML = `
                <tr>
                    <td colspan="5" class="error">
                        Failed to load documents: ${error.message}
                    </td>
                </tr>
            `;
        }
    }
}

function renderTasks(tasksData) {
    console.log('🎨 Rendering tasks:', tasksData);
    
    const tbody = document.getElementById('tasksList');
    
    if (!tbody) {
        console.error('❌ Tasks list element not found!');
        return;
    }
    
    if (!tasksData || tasksData.length === 0) {
        console.log('ℹ️ No tasks to display');
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-text-color/60 text-sm">No tasks yet. Create one above!</td></tr>';
        return;
    }
    
    console.log('📝 Rendering', tasksData.length, 'tasks');
    
    tbody.innerHTML = tasksData.map(task => {
        console.log('Rendering task:', task.title || task.name);
        
        // Handle both 'title' and 'name' fields for compatibility
        const taskTitle = task.title || task.name || 'Untitled Task';
        const assignee = task.assignee || task.assigned_to_name || 'Unassigned';
        const dueDate = task.dueDate || task.due_date || 'Not set';
        const status = task.status || 'To Do';
        
        return `
            <tr class="text-sm hover:bg-background-alt/50 cursor-pointer" onclick="window.location.href='/task-detail.html?id=${task.id}'">
                <td class="px-6 py-4 font-medium text-text-color">${escapeHtml(taskTitle)}</td>
                <td class="px-6 py-4 text-text-color/60">${escapeHtml(assignee)}</td>
                <td class="px-6 py-4 text-text-color/60">${formatDate(dueDate)}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${getTaskStatusColor(status)}">
                        ${escapeHtml(status.replace('_', ' '))}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log('✅ Tasks rendered successfully');
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString || dateString === 'Not set') return 'Not set';
    try {
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch {
        return dateString;
    }
}

function displayDocuments(documents) {
    console.log('🎨 Displaying documents:', documents);
    
    const tableBody = document.getElementById('documents-table-body');
    
    if (!tableBody) {
        console.error('❌ Documents table body not found');
        return;
    }
    
    if (documents.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">
                    No documents uploaded yet. Upload your first document!
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = documents.map(doc => `
        <tr>
            <td>
                <span class="document-icon">${getFileIcon(doc.file_type)}</span>
                ${escapeHtml(doc.name)}
            </td>
            <td>${formatFileSize(doc.file_size)}</td>
            <td>${escapeHtml(doc.uploaded_by || 'Unknown')}</td>
            <td>${formatDateTime(doc.uploaded_at)}</td>
            <td>
                <button onclick="downloadDocument('${doc.id}', '${escapeHtml(doc.url)}', '${escapeHtml(doc.name)}')" class="btn-sm">Download</button>
                <button onclick="deleteDocument('${doc.id}')" class="btn-sm btn-danger">Delete</button>
            </td>
        </tr>
    `).join('');
    
    console.log('✅ Documents displayed successfully');
}

function renderTeamMembers(members) {
    const membersList = document.getElementById('membersList');
    
    if (members.length === 0) {
        membersList.innerHTML = '<p class="text-sm text-text-color/60 text-center py-2">No team members assigned</p>';
        return;
    }
    
    membersList.innerHTML = members.map(member => `
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="text-primary font-semibold text-sm">${member.full_name.charAt(0)}</span>
                </div>
                <div>
                    <p class="font-medium text-sm text-text-color">${member.full_name}</p>
                    <p class="text-xs text-text-color/60">${member.role}</p>
                </div>
            </div>
        </div>
    `).join('');
}

function getStatusColor(status) {
    const colors = {
        'planning': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-primary/20 text-primary',
        'on_hold': 'bg-accent-2/20 text-accent-2',
        'completed': 'bg-accent-1/20 text-accent-1'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

function getTaskStatusColor(status) {
    const colors = {
        'pending': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-accent-2/20 text-accent-2',
        'overdue': 'bg-red-100 text-red-800',
        'completed': 'bg-accent-1/20 text-accent-1'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

// Helper functions for documents
function getFileIcon(mimeType) {
    if (mimeType.includes('pdf')) return '📄';
    if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
    if (mimeType.includes('sheet') || mimeType.includes('excel')) return '📊';
    if (mimeType.includes('image')) return '🖼️';
    if (mimeType.includes('zip') || mimeType.includes('compressed')) return '📦';
    return '📎';
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDateTime(dateString) {
    if (!dateString) return 'Unknown';
    try {
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString;
    }
}

function downloadDocument(id, url, name) {
    console.log('Downloading document:', name);
    
    if (!url || url === '#') {
        alert('Download URL not available');
        return;
    }
    
    // Create temporary link and trigger download
    const link = document.createElement('a');
    link.href = url;
    link.download = name;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function deleteDocument(id) {
    if (!confirm('Are you sure you want to delete this document?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/documents?id=${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete document');
        }
        
        alert('Document deleted successfully');
        
        // Reload documents
        const projectId = getProjectIdFromUrl();
        await loadProjectDocuments();
        
    } catch (error) {
        console.error('Error deleting document:', error);
        alert('Failed to delete document: ' + error.message);
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diff === 0) return 'Today';
    if (diff === 1) return 'Yesterday';
    if (diff < 7) return `${diff} days ago`;
    return date.toLocaleDateString();
}

// Upload document modal
window.showUploadDocModal = function() {
    uploadDocModal.classList.remove('hidden');
};

cancelUploadBtn.addEventListener('click', () => {
    uploadDocModal.classList.add('hidden');
});

uploadDocForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    console.log('📤 Uploading document...');
    
    const fileInput = document.getElementById('document-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to upload');
        return;
    }
    
    console.log('File selected:', {
        name: file.name,
        type: file.type,
        size: file.size
    });
    
    const projectId = getProjectIdFromUrl();
    
    if (!projectId) {
        alert('Project ID is missing');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Uploading...';
    
    try {
        // Wait for Supabase client to be ready
        if (!window.supabaseClient) {
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
            if (!window.supabaseClient) {
                throw new Error('Supabase client not initialized');
            }
        }
        
        // Generate unique file path
        const timestamp = Date.now();
        const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const filePath = `${projectId}/${timestamp}_${sanitizedFileName}`;
        
        console.log('Uploading to Supabase storage:', filePath);
        
        // Upload file to Supabase Storage
        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
            .from('olumba-documents')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        
        if (uploadError) {
            throw new Error(`Storage upload failed: ${uploadError.message}`);
        }
        
        console.log('✅ File uploaded to storage:', uploadData);
        
        // Create database record
        const response = await fetch('/api/documents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                name: file.name,
                filePath: filePath,
                fileType: file.type,
                fileSize: file.size,
                uploadedBy: 'Current User'
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create document record');
        }
        
        const result = await response.json();
        console.log('✅ Document record created:', result);
        
        alert('Document uploaded successfully!');
        
        // Reset form
        uploadDocForm.reset();
        
        // Close modal
        uploadDocModal.classList.add('hidden');
        
        // Reload documents list
        await loadProjectDocuments();
        
    } catch (error) {
        console.error('Error uploading document:', error);
        alert(`Failed to upload document: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// Load project submittals
async function loadProjectSubmittals() {
    try {
        const allSubmittals = await cityApprovals.getAll();
        const projectSubmittals = allSubmittals.filter(s => s.project_id === projectId);
        renderSubmittals(projectSubmittals);
    } catch (error) {
        console.error('Failed to load submittals:', error);
        document.getElementById('submittalsList').innerHTML = '<div class="p-6 text-center text-text-color/60 text-sm">No submittals found</div>';
    }
}

async function loadProjectTeam() {
    console.log('👥 Loading project team...');
    
    try {
        const response = await fetch(`/api/project-members?projectId=${projectId}`);
        
        if (!response.ok) {
            console.error('Failed to load team:', response.status);
            return;
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('✅ Team members loaded:', result.data);
            displayTeamMembers(result.data || []);
        } else {
            console.error('Team API error:', result.error);
        }
        
    } catch (error) {
        console.error('Error loading team:', error);
    }
}

function displayTeamMembers(members) {
    console.log('👥 Displaying team members:', members);
    
    const container = document.getElementById('team-members-list');
    
    if (!container) {
        console.error('❌ Team members container not found');
        return;
    }
    
    if (members.length === 0) {
        container.innerHTML = '<p class="text-text-color/60">No team members yet. Add members to collaborate.</p>';
        return;
    }
    
    container.innerHTML = members.map(member => `
        <div class="team-member-card bg-background rounded-lg border border-footer-border/10 p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="text-primary font-bold text-sm">${escapeHtml(member.user?.full_name?.charAt(0) || 'U')}</span>
                </div>
                <div>
                    <h4 class="font-medium text-text-color">${escapeHtml(member.user?.full_name || 'Unknown User')}</h4>
                    <p class="text-sm text-text-color/60">${escapeHtml(member.role || 'Member')}</p>
                    <p class="text-xs text-text-color/60">${escapeHtml(member.user?.email || '')}</p>
                </div>
            </div>
            <button onclick="removeMember('${member.id}')" class="btn-sm btn-danger">
                <span class="material-symbols-outlined">remove</span>
                Remove
            </button>
        </div>
    `).join('');
}

function renderSubmittals(submittalsData) {
    const submittalsList = document.getElementById('submittalsList');
    
    if (submittalsData.length === 0) {
        submittalsList.innerHTML = '<div class="p-6 text-center text-text-color/60 text-sm">No city submittals yet</div>';
        return;
    }
    
    submittalsList.innerHTML = `
        <div class="p-6 space-y-3">
            ${submittalsData.map(s => `
                <div class="flex items-center justify-between p-4 bg-background-alt rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-medium text-text-color">${s.submittal_name}</h4>
                        <div class="flex items-center gap-4 mt-1 text-xs text-text-color/60">
                            ${s.city_jurisdiction ? `<span>🏛️ ${s.city_jurisdiction}</span>` : ''}
                            ${s.plan_check_number ? `<span>📋 ${s.plan_check_number}</span>` : ''}
                            <span>📅 ${s.submission_date || 'Not set'}</span>
                        </div>
                        ${s.pending_corrections > 0 ? `<p class="text-xs text-red-500 mt-1">${s.pending_corrections} pending corrections</p>` : ''}
                    </div>
                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${getSubmittalStatusColor(s.status)}">
                        ${s.status.replace('_', ' ')}
                    </span>
                </div>
            `).join('')}
        </div>
    `;
}

function getSubmittalStatusColor(status) {
    const colors = {
        'submitted': 'bg-blue-100 text-blue-800',
        'under_review': 'bg-yellow-100 text-yellow-800',
        'corrections_required': 'bg-accent-2/20 text-accent-2',
        'approved': 'bg-accent-1/20 text-accent-1',
        'rejected': 'bg-red-100 text-red-800'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

// Modal handlers
const editProjectModal = document.getElementById('editProjectModal');
const addTaskModal = document.getElementById('addTaskModal');
const addMemberModal = document.getElementById('addMemberModal');

window.editProject = function() {
    // Populate form with current values
    document.getElementById('editProjectName').value = currentProject.name;
    document.getElementById('editProjectDescription').value = currentProject.description || '';
    document.getElementById('editProjectStatus').value = currentProject.status;
    document.getElementById('editProjectDiscipline').value = currentProject.discipline || '';
    document.getElementById('editProjectStartDate').value = currentProject.start_date || '';
    document.getElementById('editProjectDeadline').value = currentProject.deadline || '';
    document.getElementById('editProjectBudget').value = currentProject.budget || '';
    document.getElementById('editProjectAddress').value = currentProject.address || '';
    
    editProjectModal.classList.remove('hidden');
};

document.getElementById('cancelEditProjectBtn').addEventListener('click', () => {
    editProjectModal.classList.add('hidden');
});

document.getElementById('editProjectForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    try {
        await projects.update(projectId, {
            name: document.getElementById('editProjectName').value,
            description: document.getElementById('editProjectDescription').value,
            status: document.getElementById('editProjectStatus').value,
            discipline: document.getElementById('editProjectDiscipline').value,
            start_date: document.getElementById('editProjectStartDate').value || null,
            deadline: document.getElementById('editProjectDeadline').value || null,
            budget: document.getElementById('editProjectBudget').value || null,
            address: document.getElementById('editProjectAddress').value || null
        });
        
        editProjectModal.classList.add('hidden');
        loadProjectDetails();
    } catch (error) {
        alert('Failed to update project: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
    }
});

window.createTask = async function() {
    // Load team members for assignee dropdown
    if (currentProject && currentProject.members) {
        const assigneeSelect = document.getElementById('taskAssignee');
        assigneeSelect.innerHTML = '<option value="">Unassigned</option>' +
            currentProject.members.map(m => `<option value="${m.user_id}">${m.full_name}</option>`).join('');
    }
    
    addTaskModal.classList.remove('hidden');
};

document.getElementById('cancelTaskBtn').addEventListener('click', () => {
    addTaskModal.classList.add('hidden');
});

document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    console.log('🚀 Creating task...');
    console.log('Form element:', e.target);
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    try {
        // Get form data with comprehensive logging
        const taskName = document.getElementById('taskName').value;
        const taskDescription = document.getElementById('taskDescription').value;
        const taskAssignee = document.getElementById('taskAssignee').value;
        const taskPriority = document.getElementById('taskPriority').value;
        const taskDueDate = document.getElementById('taskDueDate').value;
        
        console.log('📝 Form data collected:');
        console.log('  Name:', taskName);
        console.log('  Description:', taskDescription);
        console.log('  Assignee:', taskAssignee);
        console.log('  Priority:', taskPriority);
        console.log('  Due Date:', taskDueDate);
        console.log('  Project ID:', projectId);
        
        // Validate required fields
        if (!taskName || taskName.trim() === '') {
            console.error('❌ Task name is empty');
            alert('Task name is required');
            return;
        }
        
        if (!projectId) {
            console.error('❌ No project ID');
            alert('Project ID is missing');
            return;
        }
        
        const taskData = {
            project_id: projectId,
            name: taskName,
            description: taskDescription,
            assigned_to: taskAssignee || null,
            priority: taskPriority,
            due_date: taskDueDate || null
        };
        
        console.log('📦 Task data object:', taskData);
        
        console.log('📡 Sending task to API...');
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        });
        
        console.log('📊 Response status:', response.status);
        console.log('✅ Response OK?', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('✅ Task created:', result);
        
        // Show success message
        alert('Task created successfully!');
        
        // Close modal and reset form
        addTaskModal.classList.add('hidden');
        document.getElementById('addTaskForm').reset();
        
        // Reload tasks and project details
        await loadProjectTasks();
        await loadProjectDetails();
        
    } catch (error) {
        console.error('💥 Error creating task:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert(`Failed to create task: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Task';
    }
});

window.addMember = async function() {
    // Load company users for member dropdown
    try {
        const companyUsers = await users.getAll();
        const memberSelect = document.getElementById('memberUser');
        
        // Filter out users already in project
        const existingUserIds = currentProject.members?.map(m => m.user_id) || [];
        const availableUsers = companyUsers.filter(u => !existingUserIds.includes(u.id));
        
        if (availableUsers.length === 0) {
            alert('All company users are already assigned to this project');
            return;
        }
        
        memberSelect.innerHTML = '<option value="">Select user</option>' +
            availableUsers.map(u => `<option value="${u.id}">${u.full_name} (${u.email})</option>`).join('');
        
        addMemberModal.classList.remove('hidden');
    } catch (error) {
        console.error('Failed to load users:', error);
        alert('Failed to load users. Admin only feature.');
    }
};

document.getElementById('cancelMemberBtn').addEventListener('click', () => {
    addMemberModal.classList.add('hidden');
});

document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        await projects.addMember(
            projectId,
            document.getElementById('memberUser').value,
            document.getElementById('memberRole').value
        );
        
        addMemberModal.classList.add('hidden');
        document.getElementById('addMemberForm').reset();
        loadProjectDetails();
    } catch (error) {
        alert('Failed to add member: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Member';
    }
});

// Invite Consultant Modal
const inviteConsultantModal = document.getElementById('inviteConsultantModal');
const inviteConsultantForm = document.getElementById('inviteConsultantForm');
const cancelConsultantBtn = document.getElementById('cancelConsultantBtn');
const inviteSuccessMessage = document.getElementById('inviteSuccessMessage');

window.inviteConsultant = function() {
    // Reset form
    inviteConsultantForm.reset();
    inviteSuccessMessage.classList.add('hidden');
    inviteConsultantModal.classList.remove('hidden');
};

cancelConsultantBtn.addEventListener('click', () => {
    inviteConsultantModal.classList.add('hidden');
});

inviteConsultantForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalHTML = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Sending...';
    
    try {
        const email = document.getElementById('consultantEmail').value;
        const message = document.getElementById('consultantMessage').value;
        
        const result = await users.inviteConsultant(email, projectId, message);
        
        // Show success message
        document.getElementById('sentToEmail').textContent = email;
        document.getElementById('inviteLinkDisplay').textContent = result.invitationLink;
        inviteSuccessMessage.classList.remove('hidden');
        
        // Log to console for development
        console.log('📧 Consultant invitation sent!');
        console.log('Email:', email);
        console.log('Link:', result.invitationLink);
        
        // Reset form but keep modal open to show success
        inviteConsultantForm.reset();
        
        setTimeout(() => {
            inviteConsultantModal.classList.add('hidden');
            inviteSuccessMessage.classList.add('hidden');
        }, 10000); // Close after 10 seconds
        
    } catch (error) {
        alert('Failed to send invitation: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
    }
});

// Add global error handling
window.addEventListener('error', (event) => {
  console.error('=== GLOBAL ERROR CAUGHT ===');
  console.error('Message:', event.message);
  console.error('Filename:', event.filename);
  console.error('Line:', event.lineno);
  console.error('Column:', event.colno);
  console.error('Error object:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('=== UNHANDLED PROMISE REJECTION ===');
  console.error('Reason:', event.reason);
  console.error('Promise:', event.promise);
});

// Add page load debugging
console.log('=== PROJECT DETAILS PAGE DEBUG ===');
console.log('Page loaded, starting initialization...');
console.log('Full URL:', window.location.href);
console.log('Search params:', window.location.search);

const urlParams = new URLSearchParams(window.location.search);
console.log('All URL params:');
for (let [key, value] of urlParams.entries()) {
  console.log(`  ${key}: ${value}`);
}

const projectId = urlParams.get('id');
console.log('Project ID:', projectId);
console.log('Project ID type:', typeof projectId);
console.log('Project ID length:', projectId?.length);

if (!projectId) {
  console.error('❌ No project ID found in URL!');
} else {
  console.log('✅ Project ID found, will attempt to load');
}

console.log('=== END PAGE DEBUG ===');

// Initialize page with error handling
document.addEventListener('DOMContentLoaded', async () => {
  console.log('🚀 DOMContentLoaded event fired');
  console.log('Current URL:', window.location.href);
  
  try {
    // Check if container elements exist
    const requiredElements = [
      'projectBreadcrumb', 'projectName', 'projectDescription', 'projectStatus',
      'totalTasks', 'completedTasks', 'documentCount', 'memberCount',
      'projectAddress', 'projectDiscipline', 'projectStartDate', 'projectDeadline', 'projectBudget'
    ];
    
    console.log('Checking required elements...');
    const missingElements = [];
    requiredElements.forEach(id => {
      const element = document.getElementById(id);
      if (!element) {
        missingElements.push(id);
        console.error(`❌ Missing element: ${id}`);
      } else {
        console.log(`✅ Found element: ${id}`);
      }
    });
    
    if (missingElements.length > 0) {
      console.error('❌ CRITICAL: Missing required elements:', missingElements);
      console.error('Available elements:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
      return;
    }
    
    console.log('✅ All required elements found');
    
    // Load project details
    console.log('Loading project details...');
    await loadProjectDetails();
    
    console.log('✅ Page initialization complete');
    
  } catch (error) {
    console.error('💥 Page initialization error:', error);
    console.error('Error name:', error.name);
    console.error('Error message:', error.message);
    console.error('Error stack:', error.stack);
    
    // Show error to user
    const projectName = document.getElementById('projectName');
    if (projectName) {
      projectName.textContent = 'Error Loading Project';
    }
    
    const projectDescription = document.getElementById('projectDescription');
    if (projectDescription) {
      projectDescription.innerHTML = `
        <div style="color: #dc2626; background: #fef2f2; border: 1px solid #fecaca; padding: 12px; border-radius: 6px;">
          <strong>Failed to load project details</strong><br>
          ${error.message}<br>
          <button onclick="window.location.reload()" style="margin-top: 8px; padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Try Again
          </button>
          <button onclick="window.location.href='/projects.html'" style="margin-top: 8px; margin-left: 8px; padding: 4px 8px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Back to Projects
          </button>
        </div>
      `;
    }
  }
});

// Simple test display function for debugging
function displayProjectDetailsSimple(project) {
  console.log('=== SIMPLE DISPLAY TEST ===');
  console.log('Simple display test for project:', project);
  
  // Find a container to show the raw data
  const container = document.querySelector('.container');
  
  if (!container) {
    console.error('Container not found for simple display');
    return;
  }
  
  // Create a debug panel
  const debugPanel = document.createElement('div');
  debugPanel.id = 'debug-panel';
  debugPanel.style.cssText = `
    position: fixed;
    top: 10px;
    right: 10px;
    width: 300px;
    max-height: 400px;
    background: #f0f0f0;
    border: 2px solid #333;
    padding: 10px;
    z-index: 9999;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
  `;
  
  debugPanel.innerHTML = `
    <div style="background: #333; color: white; padding: 5px; margin: -10px -10px 10px -10px;">
      <strong>DEBUG PANEL</strong>
      <button onclick="document.getElementById('debug-panel').remove()" style="float: right; background: #666; color: white; border: none; padding: 2px 6px; cursor: pointer;">×</button>
    </div>
    <div><strong>Project Data Received:</strong></div>
    <pre style="background: white; padding: 5px; margin: 5px 0; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;">${JSON.stringify(project, null, 2)}</pre>
    <div><strong>Available Elements:</strong></div>
    <div style="max-height: 100px; overflow-y: auto;">
      ${Array.from(document.querySelectorAll('[id]')).map(el => el.id).join(', ')}
    </div>
  `;
  
  // Remove existing debug panel if any
  const existing = document.getElementById('debug-panel');
  if (existing) {
    existing.remove();
  }
  
  document.body.appendChild(debugPanel);
  console.log('✅ Debug panel added');
  console.log('=== END SIMPLE DISPLAY TEST ===');
}

loadProjectDetails();
</script>
</body>
</html>
