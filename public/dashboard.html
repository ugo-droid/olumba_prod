<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dashboard - Olumba</title>
<link rel="icon" type="image/png" href="/assets/faviconolumba.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>tailwind.config = {theme: {extend: {colors: {primary: "#2171f2", "accent-1": "#22C55E", "accent-2": "#FF8C42", background: "#FFFFFF", "background-alt": "#F3F4F6", "text-color": "#22223B", "footer-border": "#1E293B"}, fontFamily: {display: "Inter"}, borderRadius: {DEFAULT: "0.5rem", lg: "1rem", xl: "1.5rem", full: "9999px"}}}};</script>
<!-- Clerk SDK removed - no authentication required -->

<!-- Vercel Speed Insights -->
<script>
    (function() {
        var script = document.createElement('script');
        script.src = 'https://unpkg.com/@vercel/speed-insights@latest/dist/index.js';
        script.defer = true;
        document.head.appendChild(script);
    })();
</script>

<script src="/js/config.js"></script>
<!-- Clerk authentication scripts removed -->
</head>
<body class="bg-background-alt font-display text-text-color">
<div id="app"></div>

<script src="/js/api.js"></script>
<script src="/js/nav.js"></script>
<script>
// Initialize dashboard page - NO AUTHENTICATION REQUIRED
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Dashboard initializing...');
    
    try {
        console.log('‚úÖ Dashboard loading without authentication');
        
        // Initialize navigation first
        initNav('dashboard');
        
        // Then load dashboard content
        await initializeDashboard();
        
    } catch (error) {
        console.error('‚ùå Failed to initialize dashboard:', error);
    }
});

async function initializeDashboard() {
    console.log('üìä Initializing dashboard content...');
    
    try {
        // Load all dashboard data in parallel
        await Promise.all([
            loadProjectStats(),
            loadTaskStats(),
            loadRecentProjects(),
            loadRecentTasks(),
            loadNotificationCount()
        ]);
        
        console.log('‚úÖ Dashboard initialization complete');
        
    } catch (error) {
        console.error('‚ùå Dashboard initialization error:', error);
        showError('Failed to load dashboard data');
    }
}

async function loadProjectStats() {
    console.log('üìà Loading project statistics...');
    
    try {
        const response = await fetch('/api/projects');
        const result = await response.json();
        
        if (result.success) {
            const projects = result.data || [];
            const stats = {
                total: projects.length,
                active: projects.filter(p => p.status === 'active' || p.status === 'in_progress').length,
                completed: projects.filter(p => p.status === 'completed').length,
                planning: projects.filter(p => p.status === 'planning').length
            };
            
            displayProjectStats(stats);
            console.log('‚úÖ Project stats loaded:', stats);
        } else {
            console.error('‚ùå Project stats API error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Load project stats error:', error);
        // Show fallback stats
        displayProjectStats({ total: 0, active: 0, completed: 0, planning: 0 });
    }
}

async function loadTaskStats() {
    console.log('üìã Loading task statistics...');
    
    try {
        const response = await fetch('/api/tasks');
        const result = await response.json();
        
        if (result.success) {
            const tasks = result.data || [];
            const stats = {
                total: tasks.length,
                pending: tasks.filter(t => t.status === 'todo' || t.status === 'pending').length,
                inProgress: tasks.filter(t => t.status === 'in_progress').length,
                completed: tasks.filter(t => t.status === 'completed').length
            };
            
            displayTaskStats(stats);
            console.log('‚úÖ Task stats loaded:', stats);
        } else {
            console.error('‚ùå Task stats API error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Load task stats error:', error);
        // Show fallback stats
        displayTaskStats({ total: 0, pending: 0, inProgress: 0, completed: 0 });
    }
}

async function loadRecentProjects() {
    console.log('üìÅ Loading recent projects...');
    
    try {
        const response = await fetch('/api/projects');
        const result = await response.json();
        
        if (result.success) {
            const projects = (result.data || []).slice(0, 5); // Get latest 5
            displayRecentProjects(projects);
            console.log('‚úÖ Recent projects loaded:', projects.length);
        } else {
            console.error('‚ùå Recent projects API error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Load recent projects error:', error);
        displayRecentProjects([]);
    }
}

async function loadRecentTasks() {
    console.log('üìù Loading recent tasks...');
    
    try {
        const response = await fetch('/api/tasks');
        const result = await response.json();
        
        if (result.success) {
            const tasks = (result.data || []).slice(0, 5); // Get latest 5
            displayRecentTasks(tasks);
            console.log('‚úÖ Recent tasks loaded:', tasks.length);
        } else {
            console.error('‚ùå Recent tasks API error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Load recent tasks error:', error);
        displayRecentTasks([]);
    }
}

async function loadNotificationCount() {
    console.log('üîî Loading notification count...');
    
    try {
        const response = await fetch('/api/notifications');
        const result = await response.json();
        
        if (result.success) {
            const unreadCount = (result.data || []).filter(n => !n.read).length;
            updateNotificationBadge(unreadCount);
            console.log('‚úÖ Notification count loaded:', unreadCount);
        } else {
            console.error('‚ùå Notifications API error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Load notification count error:', error);
        updateNotificationBadge(0);
    }
}

function displayProjectStats(stats) {
    const container = document.getElementById('project-stats');
    if (!container) return;
    
    container.innerHTML = `
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Total Projects</p>
                        <p class="text-2xl font-bold text-text-color">${stats.total}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">folder</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Active</p>
                        <p class="text-2xl font-bold text-accent-1">${stats.active}</p>
                    </div>
                    <div class="w-12 h-12 bg-accent-1/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-accent-1">play_circle</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Completed</p>
                        <p class="text-2xl font-bold text-green-500">${stats.completed}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-green-500">check_circle</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Planning</p>
                        <p class="text-2xl font-bold text-accent-2">${stats.planning}</p>
                    </div>
                    <div class="w-12 h-12 bg-accent-2/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-accent-2">schedule</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayTaskStats(stats) {
    const container = document.getElementById('task-stats');
    if (!container) return;
    
    container.innerHTML = `
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Total Tasks</p>
                        <p class="text-2xl font-bold text-text-color">${stats.total}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">task_alt</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Pending</p>
                        <p class="text-2xl font-bold text-yellow-500">${stats.pending}</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-500/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-yellow-500">pending</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">In Progress</p>
                        <p class="text-2xl font-bold text-blue-500">${stats.inProgress}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-500">play_circle</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-background rounded-xl p-6 border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-text-color/60">Completed</p>
                        <p class="text-2xl font-bold text-green-500">${stats.completed}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/10 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-green-500">check_circle</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayRecentProjects(projects) {
    const container = document.getElementById('recent-projects');
    if (!container) return;
    
    if (projects.length === 0) {
        container.innerHTML = '<p class="text-text-color/60">No recent projects</p>';
        return;
    }
    
    container.innerHTML = projects.map(project => `
        <div class="bg-background rounded-lg border border-footer-border/10 p-4 hover:shadow-sm transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-text-color">${escapeHtml(project.name)}</h4>
                    <p class="text-sm text-text-color/60">${escapeHtml(project.status || 'Unknown')}</p>
                </div>
                <a href="/project-detail.html?id=${project.id}" class="text-primary hover:underline text-sm">
                    View ‚Üí
                </a>
            </div>
        </div>
    `).join('');
}

function displayRecentTasks(tasks) {
    const container = document.getElementById('recent-tasks');
    if (!container) return;
    
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-text-color/60">No recent tasks</p>';
        return;
    }
    
    container.innerHTML = tasks.map(task => `
        <div class="bg-background rounded-lg border border-footer-border/10 p-4 hover:shadow-sm transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-text-color">${escapeHtml(task.title || task.name)}</h4>
                    <p class="text-sm text-text-color/60">${escapeHtml(task.status || 'Unknown')}</p>
                </div>
                <a href="/task-detail.html?id=${task.id}" class="text-primary hover:underline text-sm">
                    View ‚Üí
                </a>
            </div>
        </div>
    `).join('');
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
}

function showError(message) {
    console.error('Dashboard Error:', message);
    // Could show a toast notification here
}

function escapeHtml(text) {
    if (!text && text !== 0) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function initializeDashboard() {
    // Render dashboard content
    renderDashboardContent();
    
    // Load user data
    loadUserData();
    
    // Load dashboard data
    loadDashboard();
}

// Function to load user data from Clerk
async function loadUserData() {
    try {
        const user = window.clerkAuth.getCurrentUser();
        if (user) {
            // Update user name in the dashboard
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = user.fullName || user.firstName || 'User';
            }
            
            // Update user info in navigation
            updateUserNavigation(user);
        }
    } catch (error) {
        console.error('Failed to load user data:', error);
    }
}

// Function to update navigation with user info
function updateUserNavigation(user) {
    // This will be implemented in the nav.js file
    if (window.updateUserNav) {
        window.updateUserNav(user);
    }
}

// Function to render dashboard content
function renderDashboardContent() {
    const mainContent = document.getElementById('mainContent');
    if (!mainContent) {
        console.error('Main content area not found');
        return;
    }

    // Render dashboard content
    mainContent.innerHTML = `
<div class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-text-color">Welcome back, <span id="userName">User</span></h1>
            <p class="text-text-color/60 mt-1">Here's what's happening with your projects today.</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-background rounded-xl p-6 shadow-sm border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-text-color/60">Total Projects</p>
                        <p class="text-3xl font-bold text-text-color mt-1" id="totalProjects">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">folder</span>
                    </div>
                </div>
            </div>
            <div class="bg-background rounded-xl p-6 shadow-sm border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-text-color/60">Active Tasks</p>
                        <p class="text-3xl font-bold text-text-color mt-1" id="activeTasks">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-accent-2/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-accent-2">assignment</span>
                    </div>
                </div>
            </div>
            <div class="bg-background rounded-xl p-6 shadow-sm border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-text-color/60">Completed</p>
                        <p class="text-3xl font-bold text-text-color mt-1" id="completedTasks">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-accent-1/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-accent-1">check_circle</span>
                    </div>
                </div>
            </div>
            <div class="bg-background rounded-xl p-6 shadow-sm border border-footer-border/10">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-text-color/60">Overdue</p>
                        <p class="text-3xl font-bold text-red-500 mt-1" id="overdueTasks">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-500">warning</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="bg-background rounded-xl shadow-sm border border-footer-border/10 mb-8">
            <div class="p-6 border-b border-footer-border/10 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-text-color">Recent Projects</h2>
                <a href="/projects.html" class="text-sm text-primary hover:text-primary/80 font-medium">View All ‚Üí</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b border-primary bg-primary">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Project Name</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Status</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white text-center">Overdue Tasks</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Deadline</th>
                        </tr>
                    </thead>
                    <tbody id="projectsList" class="divide-y divide-footer-border/10">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-text-color/60">
                                <span class="material-symbols-outlined text-4xl mb-2">folder_open</span>
                                <p>Loading projects...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="bg-background rounded-xl shadow-sm border border-footer-border/10">
            <div class="p-6 border-b border-footer-border/10 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-text-color">My Tasks</h2>
                <a href="/tasks.html" class="text-sm text-primary hover:text-primary/80 font-medium">View All ‚Üí</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b border-primary bg-primary">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Task</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Project</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Due Date</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tasksList" class="divide-y divide-footer-border/10">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-text-color/60">
                                <span class="material-symbols-outlined text-4xl mb-2">assignment</span>
                                <p>Loading tasks...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
`;
}

// Update user name in dashboard (handled by loadUserData function)

// Load dashboard data
async function loadDashboard() {
    try {
        const projectsData = await projects.getAll();
        document.getElementById('totalProjects').textContent = projectsData.length;
        
        const tasksData = await tasks.getMyTasks();
        const activeTasks = tasksData.filter(t => t.status === 'in_progress' || t.status === 'pending');
        const completedTasks = tasksData.filter(t => t.status === 'completed');
        const overdueTasks = tasksData.filter(t => t.status === 'overdue');
        
        document.getElementById('activeTasks').textContent = activeTasks.length;
        document.getElementById('completedTasks').textContent = completedTasks.length;
        document.getElementById('overdueTasks').textContent = overdueTasks.length;
        
        renderProjects(projectsData.slice(0, 5));
        renderTasks(tasksData.slice(0, 10));
        
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

function renderProjects(projectsData) {
    const tbody = document.getElementById('projectsList');
    
    if (projectsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-8 text-center text-text-color/60">
                    <span class="material-symbols-outlined text-4xl mb-2">folder_open</span>
                    <p>No projects yet</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = projectsData.map(project => `
        <tr class="text-sm hover:bg-background-alt/50 cursor-pointer" onclick="window.location.href='/projects.html'">
            <td class="px-6 py-4 font-medium text-text-color">${project.name}</td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${getStatusColor(project.status)}">
                    ${project.status.replace('_', ' ')}
                </span>
            </td>
            <td class="px-6 py-4 text-center ${project.overdue_tasks > 0 ? 'text-red-500 font-semibold' : 'text-text-color/60'}">
                ${project.overdue_tasks || 0}
            </td>
            <td class="px-6 py-4 text-text-color/60">${project.deadline || 'Not set'}</td>
        </tr>
    `).join('');
}

function renderTasks(tasksData) {
    const tbody = document.getElementById('tasksList');
    
    if (tasksData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-8 text-center text-text-color/60">
                    <span class="material-symbols-outlined text-4xl mb-2">assignment</span>
                    <p>No tasks assigned</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = tasksData.map(task => `
        <tr class="text-sm hover:bg-background-alt/50">
            <td class="px-6 py-4 font-medium text-text-color">${task.name}</td>
            <td class="px-6 py-4 text-text-color/60">${task.project_name}</td>
            <td class="px-6 py-4 text-text-color/60">${task.due_date || 'Not set'}</td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${getTaskStatusColor(task.status)}">
                    ${task.status.replace('_', ' ')}
                </span>
            </td>
        </tr>
    `).join('');
}

function getStatusColor(status) {
    const colors = {
        'planning': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-primary/20 text-primary',
        'on_hold': 'bg-accent-2/20 text-accent-2',
        'completed': 'bg-accent-1/20 text-accent-1',
        'cancelled': 'bg-gray-200 text-gray-600'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

function getTaskStatusColor(status) {
    const colors = {
        'pending': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-accent-2/20 text-accent-2',
        'overdue': 'bg-red-100 text-red-800',
        'completed': 'bg-accent-1/20 text-accent-1',
        'cancelled': 'bg-gray-200 text-gray-600'
    };
    return colors[status] || 'bg-gray-200 text-gray-600';
}

loadDashboard();
</script>
</body>
</html>